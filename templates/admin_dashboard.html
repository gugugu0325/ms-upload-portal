{% extends 'base.html' %}
{% block content %}
<h2>GM 後台</h2>
<form method="get" class="filters">
  <input type="text" name="q" value="{{ q }}" placeholder="搜尋遊戲 ID">
  <input type="date" name="start" value="{{ start }}">
  <input type="date" name="end" value="{{ end }}">
  <select name="status">
    <option value="" {% if not status %}selected{% endif %}>全部</option>
    <option value="pending" {% if status=='pending' %}selected{% endif %}>只看未發放</option>
    <option value="granted" {% if status=='granted' %}selected{% endif %}>只看已發放</option>
  </select>
  <button type="submit">套用篩選</button>
  <a class="btn" href="{{ url_for('gm_logout') }}">登出</a>
</form>

<h3>首次資料</h3>
<table>
  <thead>
    <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>ID</th><th>遊戲ID</th><th>時間</th><th>事前預約</th><th>Discord 推廣</th><th>狀態</th><th>操作</th></tr>
  </thead>
  <tbody>
    {% for s in subs %}
    <tr>
      <td><input type="checkbox" name="ids" value="{{ s.id }}" form="batch_sub"></td>
      <td>#{{ s.id }}</td>
      <td>{{ s.game_id }}</td>
      <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>
        <a href="{{ url_for('uploaded_file', filename=s.prereg_1) }}" target="_blank">圖1</a>、
        <a href="{{ url_for('uploaded_file', filename=s.prereg_2) }}" target="_blank">圖2</a>
      </td>
      <td>
        <a href="{{ url_for('uploaded_file', filename=s.discord_1) }}" target="_blank">圖1</a>、
        <a href="{{ url_for('uploaded_file', filename=s.discord_2) }}" target="_blank">圖2</a>
      </td>
      <td>{% if s.is_granted %}<span class="tag done">已發放</span>{% else %}<span class="tag todo">未發放</span>{% endif %}</td>
      <td>
        <a href="{{ url_for('gm_view_submission', sid=s.id) }}">檢視</a>｜
        <a href="{{ url_for('gm_mark_submission', sid=s.id, q=q, start=start, end=end, status=status) }}" onclick="return confirm('切換這筆發放狀態？')">{% if s.is_granted %}改為未發放{% else %}標註已發放{% endif %}</a>｜
        <a href="{{ url_for('gm_delete_sub', sid=s.id, q=q, start=start, end=end, status=status) }}" onclick="return confirm('確定刪除 Submission #{{ s.id }}？此動作無法復原！')">刪除</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<form id="batch_sub" method="post" action="{{ url_for('gm_batch_mark', q=q, start=start, end=end, status=status) }}">
  <input type="hidden" name="table" value="submission">
  <button type="submit">批次標註已發放（首次資料）</button>
</form>

<h3>每日推文</h3>
<table>
  <thead>
    <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>ID</th><th>遊戲ID</th><th>時間</th><th>截圖</th><th>備註</th><th>狀態</th><th>操作</th></tr>
  </thead>
  <tbody>
    {% for t in tweets %}
    <tr>
      <td><input type="checkbox" name="ids" value="{{ t.id }}" form="batch_tweet"></td>
      <td>#{{ t.id }}</td>
      <td>{{ t.game_id }}</td>
      <td>{{ t.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td><a href="{{ url_for('uploaded_file', filename=t.image_path) }}" target="_blank">查看</a></td>
      <td>{{ t.notes or '-' }}</td>
      <td>{% if t.is_granted %}<span class="tag done">已發放</span>{% else %}<span class="tag todo">未發放</span>{% endif %}</td>
      <td>
        <a href="{{ url_for('gm_mark_tweet', tid=t.id, q=q, start=start, end=end, status=status) }}" onclick="return confirm('切換這筆發放狀態？')">{% if t.is_granted %}改為未發放{% else %}標註已發放{% endif %}</a>｜
        <a href="{{ url_for('gm_delete_tweet', tid=t.id, q=q, start=start, end=end, status=status) }}" onclick="return confirm('確定刪除 DailyTweet #{{ t.id }}？此動作無法復原！')">刪除</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<form id="batch_tweet" method="post" action="{{ url_for('gm_batch_mark', q=q, start=start, end=end, status=status) }}">
  <input type="hidden" name="table" value="tweet">
  <button type="submit">批次標註已發放（每日推文）</button>
</form>

<h3>Discord 點讚</h3>
<table>
  <thead>
    <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>ID</th><th>遊戲ID</th><th>時間</th><th>截圖</th><th>備註</th><th>狀態</th><th>操作</th></tr>
  </thead>
  <tbody>
    {% for r in likes %}
    <tr>
      <td><input type="checkbox" name="ids" value="{{ r.id }}" form="batch_dclike"></td>
      <td>#{{ r.id }}</td>
      <td>{{ r.game_id }}</td>
      <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td><a href="{{ url_for('uploaded_file', filename=r.image_path) }}" target="_blank">查看</a></td>
      <td>{{ r.notes or '-' }}</td>
      <td>{% if r.is_granted %}<span class="tag done">已發放</span>{% else %}<span class="tag todo">未發放</span>{% endif %}</td>
      <td>
        <a href="{{ url_for('gm_mark_dclike', lid=r.id, q=q, start=start, end=end, status=status) }}" onclick="return confirm('切換這筆發放狀態？')">{% if r.is_granted %}改為未發放{% else %}標註已發放{% endif %}</a>｜
        <a href="{{ url_for('gm_delete_dclike', lid=r.id, q=q, start=start, end=end, status=status) }}" onclick="return confirm('確定刪除 DcLike #{{ r.id }}？此動作無法復原！')">刪除</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<form id="batch_dclike" method="post" action="{{ url_for('gm_batch_mark', q=q, start=start, end=end, status=status) }}">
  <input type="hidden" name="table" value="dclike">
  <button type="submit">批次標註已發放（Discord 點讚）</button>
</form>

<script>
function toggleAll(master){
  const table = master.closest('table');
  table.querySelectorAll('input[type=checkbox][name=ids]').forEach(cb=>cb.checked = master.checked);
}
</script>
{% endblock %}
